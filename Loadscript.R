## Test script for JSON data

library(rjson)
library(dplyr)
setwd("~/R/working/FlightData")

files <- paste("2016-06-20-000",as.character(0:9),"Z.json", sep="")

for (i in 1:length(files)) {
  loadData(files[i],"Main_database.csv")
}

files <- paste("2016-06-20-00",as.character(10:59),"Z.json", sep="")

for (i in 1:length(files)) {
  loadData(files[i],"Main_database.csv")
}

files <- paste("2016-06-20-010",as.character(0:9),"Z.json", sep="")

for (i in 1:length(files)) {
  loadData(files[i],"Main_database.csv")
}

files <- paste("2016-06-20-01",as.character(10:59),"Z.json", sep="")

for (i in 1:length(files)) {
  loadData(files[i],"Main_database.csv")
}

files <- paste("2016-06-20-020",as.character(0:9),"Z.json", sep="")

for (i in 1:length(files)) {
  loadData(files[i],"Main_database.csv")
}

files <- paste("2016-06-20-02",as.character(10:59),"Z.json", sep="")

for (i in 1:length(files)) {
  loadData(files[i],"Main_database.csv")
}

files <- paste("2016-06-20-030",as.character(0:9),"Z.json", sep="")

for (i in 1:length(files)) {
  loadData(files[i],"Main_database.csv")
}

files <- paste("2016-06-20-03",as.character(10:59),"Z.json", sep="")

for (i in 1:length(files)) {
  loadData(files[i],"Main_database.csv")
}

files <- paste("2016-06-20-040",as.character(0:9),"Z.json", sep="")

for (i in 1:length(files)) {
  loadData(files[i],"Main_database.csv")
}

files <- paste("2016-06-20-04",as.character(10:59),"Z.json", sep="")

for (i in 1:length(files)) {
  loadData(files[i],"Main_database.csv")
}

files <- paste("2016-06-20-050",as.character(0:9),"Z.json", sep="")

for (i in 1:length(files)) {
  loadData(files[i],"Main_database.csv")
}

files <- paste("2016-06-20-05",as.character(10:59),"Z.json", sep="")

for (i in 1:length(files)) {
  loadData(files[i],"Main_database.csv")
}

files <- paste("2016-06-20-060",as.character(0:9),"Z.json", sep="")

for (i in 1:length(files)) {
  loadData(files[i],"Main_database.csv")
}

files <- paste("2016-06-20-06",as.character(10:59),"Z.json", sep="")

for (i in 1:length(files)) {
  loadData(files[i],"Main_database.csv")
}

files <- paste("2016-06-20-070",as.character(0:9),"Z.json", sep="")

for (i in 1:length(files)) {
  loadData(files[i],"Main_database.csv")
}

files <- paste("2016-06-20-07",as.character(10:59),"Z.json", sep="")

for (i in 1:length(files)) {
  loadData(files[i],"Main_database.csv")
}

files <- paste("2016-06-20-080",as.character(0:9),"Z.json", sep="")

for (i in 1:length(files)) {
  loadData(files[i],"Main_database.csv")
}

files <- paste("2016-06-20-08",as.character(10:59),"Z.json", sep="")

for (i in 1:length(files)) {
  loadData(files[i],"Main_database.csv")
}

files <- paste("2016-06-20-090",as.character(0:9),"Z.json", sep="")

for (i in 1:length(files)) {
  loadData(files[i],"Main_database.csv")
}

files <- paste("2016-06-20-09",as.character(10:59),"Z.json", sep="")

for (i in 1:length(files)) {
  loadData(files[i],"Main_database.csv")
}

files <- paste("2016-06-20-100",as.character(0:9),"Z.json", sep="")

for (i in 1:length(files)) {
  loadData(files[i],"Main_database.csv")
}

files <- paste("2016-06-20-10",as.character(10:59),"Z.json", sep="")

for (i in 1:length(files)) {
  loadData(files[i],"Main_database.csv")
}

files <- paste("2016-06-20-110",as.character(0:9),"Z.json", sep="")

for (i in 1:length(files)) {
  loadData(files[i],"Main_database.csv")
}

files <- paste("2016-06-20-11",as.character(10:59),"Z.json", sep="")

for (i in 1:length(files)) {
  loadData(files[i],"Main_database.csv")
}

############

files <- paste("2016-06-20-120",as.character(0:9),"Z.json", sep="")

for (i in 1:length(files)) {
  loadData(files[i],"Main_database.csv")
}

files <- paste("2016-06-20-12",as.character(10:59),"Z.json", sep="")

for (i in 1:length(files)) {
  loadData(files[i],"Main_database.csv")
}

files <- paste("2016-06-20-130",as.character(0:9),"Z.json", sep="")

for (i in 1:length(files)) {
  loadData(files[i],"Main_database.csv")
}

files <- paste("2016-06-20-13",as.character(10:59),"Z.json", sep="")

for (i in 1:length(files)) {
  loadData(files[i],"Main_database.csv")
}

files <- paste("2016-06-20-140",as.character(0:9),"Z.json", sep="")

for (i in 1:length(files)) {
  loadData(files[i],"Main_database.csv")
}

files <- paste("2016-06-20-14",as.character(10:59),"Z.json", sep="")

for (i in 1:length(files)) {
  loadData(files[i],"Main_database.csv")
}

files <- paste("2016-06-20-150",as.character(0:9),"Z.json", sep="")

for (i in 1:length(files)) {
  loadData(files[i],"Main_database.csv")
}

files <- paste("2016-06-20-15",as.character(10:59),"Z.json", sep="")

for (i in 1:length(files)) {
  loadData(files[i],"Main_database.csv")
}

files <- paste("2016-06-20-160",as.character(0:9),"Z.json", sep="")

for (i in 1:length(files)) {
  loadData(files[i],"Main_database.csv")
}

files <- paste("2016-06-20-16",as.character(10:59),"Z.json", sep="")

for (i in 1:length(files)) {
  loadData(files[i],"Main_database.csv")
}

files <- paste("2016-06-20-170",as.character(0:9),"Z.json", sep="")

for (i in 1:length(files)) {
  loadData(files[i],"Main_database.csv")
}

files <- paste("2016-06-20-17",as.character(10:59),"Z.json", sep="")

for (i in 1:length(files)) {
  loadData(files[i],"Main_database.csv")
}

files <- paste("2016-06-20-180",as.character(0:9),"Z.json", sep="")

for (i in 1:length(files)) {
  loadData(files[i],"Main_database.csv")
}

files <- paste("2016-06-20-18",as.character(10:59),"Z.json", sep="")

for (i in 1:length(files)) {
  loadData(files[i],"Main_database.csv")
}

files <- paste("2016-06-20-190",as.character(0:9),"Z.json", sep="")

for (i in 1:length(files)) {
  loadData(files[i],"Main_database.csv")
}

files <- paste("2016-06-20-19",as.character(10:59),"Z.json", sep="")

for (i in 1:length(files)) {
  loadData(files[i],"Main_database.csv")
}

files <- paste("2016-06-20-200",as.character(0:9),"Z.json", sep="")

for (i in 1:length(files)) {
  loadData(files[i],"Main_database.csv")
}

files <- paste("2016-06-20-20",as.character(10:59),"Z.json", sep="")

for (i in 1:length(files)) {
  loadData(files[i],"Main_database.csv")
}

files <- paste("2016-06-20-210",as.character(0:9),"Z.json", sep="")

for (i in 1:length(files)) {
  loadData(files[i],"Main_database.csv")
}

files <- paste("2016-06-20-21",as.character(10:59),"Z.json", sep="")

for (i in 1:length(files)) {
  loadData(files[i],"Main_database.csv")
}

files <- paste("2016-06-20-220",as.character(0:9),"Z.json", sep="")

for (i in 1:length(files)) {
  loadData(files[i],"Main_database.csv")
}

files <- paste("2016-06-20-22",as.character(10:59),"Z.json", sep="")

for (i in 1:length(files)) {
  loadData(files[i],"Main_database.csv")
}

files <- paste("2016-06-20-230",as.character(0:9),"Z.json", sep="")

for (i in 1:length(files)) {
  loadData(files[i],"Main_database.csv")
}

files <- paste("2016-06-20-23",as.character(10:59),"Z.json", sep="")

for (i in 1:length(files)) {
  loadData(files[i],"Main_database.csv")
}

#fileS <- c("2016-06-20-0000Z.json",
#              "2016-06-20-0001Z.json",
#              "2016-06-20-0002Z.json")

dataFile <- "Main_database.csv"

loadData <- function(fileName,dataFile) {

  jsonData <- fromJSON(file = fileName)
  acLists <- jsonData$acList

  nullToNA <- function(x) {
    x[sapply(x, is.null)] <- NA
    return(x)
  }

  acData <- data.frame(Id=unlist(sapply(acLists,function(x) {x$Id})))
  acData$Type <- unlist(nullToNA(sapply(acLists,function(x) {x$Type})))
  acData$ICAO <- unlist(nullToNA(sapply(acLists,function(x) {x$Icao})))
  acData$Reg <- unlist(nullToNA(sapply(acLists,function(x) {x$Reg})))
  acData$From <- unlist(nullToNA(sapply(acLists,function(x) {x$From})))
  acData$To <- unlist(nullToNA(sapply(acLists,function(x) {x$To})))
  acData$Call <- unlist(nullToNA(sapply(acLists,function(x) {x$Call})))
  acData$File <- substr(fileName,1,nchar(fileName)-5)
  
  acData <- as.data.frame(acData)
  
  A320Data <- rbind(acData[grep("A319",acData$Type),],
                  acData[grep("A320",acData$Type),],
                  acData[grep("A321",acData$Type),])
  
  write.table(A320Data,file = dataFile,
              append = TRUE, 
              sep = ",", 
              col.names = FALSE,
              row.names = FALSE)
}


# fileS <- list.files()

for (i in 1:length(files)) {
  loadData(files[i],"Main_database.csv")
}

## Function to clean up main database

inpData <- read.csv("Main_database.csv")

xs <- order(distinct(as.data.frame(as.character(inpData$Reg))))

outpData <- inpData[,-c(8)] %>% distinct() %>% inner_join(inpData[,c(1,8)],by = "Id")

write.csv(outpData, "Main_database.csv")

## function to load the data for a single aircraft

acPath <- function(acReg) {
  newData <- read.csv("Main_database.csv", header = TRUE, row.names = NULL)

  acData <- newData[!is.na(newData$Reg),]
  acData <- acData[acData$Reg==acReg,]

  jsonData <- fromJSON(file = paste(as.character(acData[1,]$File),".json",sep=""))
  acInfo <- jsonData$acList

  targetData <- acInfo[[as.numeric(acData[1,1])]]$Cos
  targetData[lapply(targetData,is.null)==TRUE] <- NA
  fullData <- matrix(unlist(targetData), ncol = 4, byrow=TRUE)

  for (i in 2:nrow(acData)) {
  
    jsonData <- fromJSON(file = paste(as.character(acData[i,]$File),".json",sep=""))
    acInfo <- jsonData$acList
  
    targetData <- acInfo[[as.numeric(acData[i,1])]]$Cos
    targetData[lapply(targetData,is.null)==TRUE] <- NA
    targetData <- matrix(unlist(targetData), ncol = 4, byrow=TRUE)
  
    fullData <- rbind(fullData,targetData)
  }
  
  fullData <- unique(fullData)
  colnames(fullData) <- c("Lat", "Lon", "Time", "Alt")
  fullData
}

testData <- acPath("G-EUPD")

## Plot a trajectory on the map

library(leaflet)

myMap <- testData %>%
  leaflet() %>%
  addTiles() %>%
  addMarkers(data = testData, lng = ~Lon, lat = ~Lat)
myMap

##


## 


jsonData <- fromJSON(file = paste(as.character(xr[1,]$File),".json",sep=""))
acInfo <- jsonData$acList

nullToNA <- function(x) {
  x[sapply(x, is.null)] <- NA
  return(x)
}

xt <- unlist(nullToNAL(acInfo[[24]]$Cos))
xt <- matrix(xt, ncol = 4, byrow = TRUE)

jsonData <- fromJSON(file = paste(as.character(xr[2,]$File),".json",sep=""))
acInfo <- jsonData$acList

xc <- acInfo[[as.numeric(xr[2,1])]]$Cos
xc[lapply(xc,is.null)==TRUE] <- NA
xc <- unlist(xc)
xc <- matrix(xc, ncol = 4, byrow=TRUE)

rbind(xt,xc)



xm <- unlist(nullToNA(acInfo[[xr[2,]$row.names]]$Cos))
xm <- matrix(xt, ncol = 4, byrow = TRUE)
rbind(xt,xm)



acData <- data.frame(Id=unlist(sapply(acLists,function(x) {x$Id})))
acData$Type <- unlist(nullToNA(sapply(acLists,function(x) {x$Type})))



for (i in 1:length(xr)){
  jsonData <- fromJSON(file = as.character(xr$File))
  acInfo <- jsonData$acList
  
  nullToNA <- function(x) {
    x[sapply(x, is.null)] <- NA
    return(x)
  }
  
  acData <- data.frame(Id=unlist(sapply(acLists,function(x) {x$Id})))
  acData$Type <- unlist(nullToNA(sapply(acLists,function(x) {x$Type})))
}

nullToNA <- function(x) {
  x[sapply(x, is.null)] <- NA
  return(x)
}

loadPos <- function(dataFile, regList, fileName) {
  
  ## Loads the position data for all of the specified a/c registrations in regList 
  ## in the json files in dataFile into a simple table, and stores it in fileName
  
  fileName = "~/R/working/FlightData/Pos_Database.csv"
  
  inpData <- read.csv("~/R/working/FlightData/Main_database.csv", stringsAsFactors = FALSE)
  
  regList <- as.data.frame(inpData$Reg) %>% arrange(inpData$Reg) %>% distinct()
  
  nullToNA <- function(x) {
    x[sapply(x, is.null)] <- NA
    return(x)
  }
  
  for (i in 1:nrow(regList)) {
    
    fileList <- inpData[inpData$Reg == regList[i,1],]$File
    
    for (j in 1:length(fileList)) {
      
      jsonData <- fromJSON(file = paste("~/R/working/FlightData/",fileList[j],".json", sep=""))
      acLists <- jsonData$acList
      
      thisReg <- unlist(nullToNA(sapply(acLists,function(x) {x$Reg})))
      
      listPos <- which(thisReg==regList[i,1] & !is.na(thisReg))
      
      acPos <- acLists[[listPos]]$Cos
      
      if (!is.null(acPos)) {
        acPos <- unlist(nullToNA(acPos))
        if (!exists("acMatrix")) 
          acMatrix <- matrix(acPos, ncol = 4, byrow = TRUE)
        else
          acMatrix <- rbind(acMatrix,matrix(acPos, ncol = 4, byrow = TRUE))
      }
      
    }

    acMatrix <- cbind(matrix(rep(regList[i,1],times=nrow(acMatrix)),ncol = 1),acMatrix)
    
    colnames(acMatrix) <- c("Reg","Lat","Lon","Time","Alt")
    
    write.table(acMatrix,file = fileName,
                append = TRUE, 
                sep = ",", 
                col.names = FALSE,
                row.names = FALSE)
    
    rm(acMatrix)
    
  }

}

loadAC <- function(dataFile, acReg) {
  
  nullToNA <- function(x) {
    x[sapply(x, is.null)] <- NA
    return(x)
  }
  
  acData <- read.csv(dataFile)
  
  fileList <- acData[acData$Reg == acReg,]$File
  
  for (i in 1:length(fileList)) {
    
    jsonData <- fromJSON(file = paste(fileList[i],".json", sep=""))
    acLists <- jsonData$acList
    
    thisReg <- unlist(nullToNA(sapply(acLists,function(x) {x$Reg})))
    
    listPos <- which(thisReg==acReg & !is.na(thisReg))
    
    acPos <- acLists[[listPos]]$Cos
    
    if (!is.null(acPos)) {
      acPos <- unlist(nullToNA(acPos))
      if (!exists("acMatrix")) 
        acMatrix <- matrix(acPos, ncol = 4, byrow = TRUE)
      else
        acMatrix <- rbind(acMatrix,matrix(acPos, ncol = 4, byrow = TRUE))
    }

  }
  
  return(acMatrix)
  
}

